import os
from flask import Flask, request, send_file
import requests
import logging
import csv
from io import StringIO, BytesIO
from dotenv import load_dotenv
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from datetime import datetime, timedelta

# ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –Ω–µ –ø—Ä–æ–¥–∞–∫—à–Ω
if os.environ.get("FLASK_ENV") != "production":
    load_dotenv()

logging.basicConfig(level=logging.INFO)

app = Flask(__name__)

user_states = {}  # user_id -> current step
user_data = {}    # user_id -> {name, surname, tournament}
user_data_confirmed = {}  # ‚úÖ —Å—é–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

BOT_TOKEN = os.environ.get("TELEGRAM_BOT_TOKEN")
URL = f"https://api.telegram.org/bot{BOT_TOKEN}"
CONFIRMED_USERS_FILE = "confirmed_users.csv"

# üîΩ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Sheets
scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
creds = ServiceAccountCredentials.from_json_keyfile_name("google-credentials.json", scope)
client = gspread.authorize(creds)
sheet = client.open("–¢—É—Ä–Ω–∏—Ä –∑–∞—è–≤–∫–∏").sheet1
config_sheet = client.open("–¢—É—Ä–Ω–∏—Ä –∑–∞—è–≤–∫–∏").worksheet("config")

def get_current_tournament():
    try:
        return config_sheet.acell("B1").value.strip()
    except Exception as e:
        logging.error(f"‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞ –∏–∑ Sheets: {e}")
        return ""

def get_tournament_description():
    try:
        return config_sheet.acell("B2").value.strip()
    except Exception as e:
        logging.error(f"‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞ –∏–∑ Sheets: {e}")
        return ""

def save_confirmed_user_to_file(number, data):
    is_new_file = not os.path.exists(CONFIRMED_USERS_FILE)
    timestamp = datetime.utcnow() + timedelta(hours=5)
    date_str = timestamp.strftime("%Y-%m-%d")
    time_str = timestamp.strftime("%H:%M:%S")
    with open(CONFIRMED_USERS_FILE, "a", newline="", encoding="utf-8") as f:
        writer = csv.writer(f)
        if is_new_file:
            writer.writerow(["ID", "–ò–º—è", "–§–∞–º–∏–ª–∏—è", "–¢—É—Ä–Ω–∏—Ä", "–î–∞—Ç–∞", "–í—Ä–µ–º—è"])
        writer.writerow([
            number,
            data.get("name", ""),
            data.get("surname", ""),
            get_current_tournament(),
            date_str,
            time_str
        ])

    try:
        sheet.append_row([
            number,
            data.get("name", ""),
            data.get("surname", ""),
            get_current_tournament(),
            date_str,
            time_str
        ])
        logging.info("üìÑ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ Google Sheets")
    except Exception as e:
        logging.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ Google Sheets: {e}")

@app.route(f"/webhook/{BOT_TOKEN}", methods=["POST"])
def receive_update():
    data = request.get_json()
    logging.info(f"‚û° –ü–æ–ª—É—á–µ–Ω–æ: {data}")
    if "message" in data:
        chat_id = data["message"]["chat"]["id"]
        text = data["message"].get("text", "").strip()

        state = user_states.get(chat_id, 'start')

        if state == 'start':
            description = get_tournament_description()
            greeting = f"–ü—Ä–∏–≥–ª–∞—à–∞–µ–º –í–∞—Å –ø—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ç—É—Ä–Ω–∏—Ä–µ:\n{description}\n\n–î–ª—è —É—á–∞—Å—Ç–∏—è –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ—ë –∏–º—è:"
            send_telegram_message(chat_id, greeting)
            user_states[chat_id] = 'wait_name'

        elif state == 'wait_name':
            user_data[chat_id] = {'name': text}
            send_telegram_message(chat_id, "–°–ø–∞—Å–∏–±–æ! –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏ —Ñ–∞–º–∏–ª–∏—é.")
            user_states[chat_id] = 'wait_surname'

        elif state == 'wait_surname':
            user_data[chat_id]['surname'] = text
            tournament = get_current_tournament()
            send_telegram_message(chat_id, f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Ç—É—Ä–Ω–∏—Ä '{tournament}'? –û—Ç–≤–µ—Ç—å—Ç–µ 1 ‚Äî –î–∞, 2 ‚Äî –ù–µ—Ç.")
            user_states[chat_id] = 'confirm'

        elif state == 'confirm':
            if text == '1':
                send_telegram_message(chat_id, "‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞! –°–ø–∞—Å–∏–±–æ!")
                user_data_confirmed[chat_id] = user_data[chat_id].copy()
                save_confirmed_user_to_file(chat_id, user_data[chat_id])
                logging.info(f"üì¶ –î–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞: {user_data[chat_id]}")
            else:
                send_telegram_message(chat_id, "‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.")
            user_states.pop(chat_id, None)
            user_data.pop(chat_id, None)
    return {"ok": True}

def send_telegram_message(chat_id, text):
    requests.post(f"{URL}/sendMessage", json={
        "chat_id": chat_id,
        "text": text
    })

def set_webhook():
    webhook_url = f"https://whatsapp-tournament-bot.onrender.com/webhook/{BOT_TOKEN}"
    r = requests.get(f"{URL}/setWebhook?url={webhook_url}")
    print("Webhook setup:", r.text)

@app.route("/export", methods=["GET"])
def export_users():
    if not os.path.exists(CONFIRMED_USERS_FILE):
        return "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏", 200

    return send_file(
        CONFIRMED_USERS_FILE,
        mimetype="text/csv",
        as_attachment=True,
        download_name="users.csv"
    )

@app.route("/ping")
def ping():
    return "", 204

if __name__ == "__main__":
    set_webhook()
    port = int(os.environ.get("PORT", 5001))
    app.run(host="0.0.0.0", port=port)
